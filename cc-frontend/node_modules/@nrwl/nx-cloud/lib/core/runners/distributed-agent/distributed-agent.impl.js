const a5_0x129c=['true','./node_modules/.cache/nx','maxParallel','reset','CIRCLE_JOB','execSync','status','floor','join','options','createNoNewMessagesTimeout','printRunGroupError','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','warn','catch','NX_AGENT_NAME','../../../utilities/metric-logger','cacheDirectory','Duplicate\x20Agent\x20ID\x20Detected','submitRunMetrics','DistributedAgentApi','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','map','default','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','VERBOSE_LOGGING','unlinkSync','__esModule','defineProperty','throw','Other\x20Nx\x20Cloud\x20Agents\x20Detected','toString','/nx.json','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','configuration','apply','assign','retryDuring','parse','child_process','error','tasks','env','mkdirSync','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','./distributed-agent.api','completedStatusCode','executionId','/lockfiles','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','next','SIGINT','\x20--projects=','length','completed:\x20','../../error/print-run-group-error','\x20--parallel\x20--max-parallel=','includes','Distributed\x20Execution\x20Terminated','value','target','projects','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','Agent\x20','Waiting...','forEach','retryDuring:\x20','startAgent','CIRCLECI','../../../utilities/environment','push','note','getTime','completed','../../../utilities/waiter','completeRunGroupWithError','projectName','CIRCLE_STAGE','wait',').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.','Waiter','executionId:\x20','inherit','../../../utilities/create-no-new-messages-timeout','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','API\x20Response','then','criticalErrorMessage','message','tasksRunnerOptions','getRunGroup','exit','npx\x20nx\x20run-many\x20--target=','Critical\x20Error\x20in\x20Agent:\x20\x22','params','taskId'];(function(_0x4382b3,_0x129cfa){const _0x33e5f7=function(_0x5b4125){while(--_0x5b4125){_0x4382b3['push'](_0x4382b3['shift']());}};_0x33e5f7(++_0x129cfa);}(a5_0x129c,0x17f));const a5_0x33e5=function(_0x4382b3,_0x129cfa){_0x4382b3=_0x4382b3-0x0;let _0x33e5f7=a5_0x129c[_0x4382b3];return _0x33e5f7;};'use strict';var __awaiter=this&&this['__awaiter']||function(_0x45e6e2,_0x12cd8f,_0x2dfff5,_0x2b6c52){function _0xa3d469(_0x4c6857){return _0x4c6857 instanceof _0x2dfff5?_0x4c6857:new _0x2dfff5(function(_0x4ab378){_0x4ab378(_0x4c6857);});}return new(_0x2dfff5||(_0x2dfff5=Promise))(function(_0x501b1c,_0x51d88c){function _0x16a0a9(_0x59e95a){try{_0x1fbaf5(_0x2b6c52[a5_0x33e5('0x33')](_0x59e95a));}catch(_0xa00579){_0x51d88c(_0xa00579);}}function _0xa51b8b(_0x22c06e){try{_0x1fbaf5(_0x2b6c52[a5_0x33e5('0x1e')](_0x22c06e));}catch(_0x58b8eb){_0x51d88c(_0x58b8eb);}}function _0x1fbaf5(_0xdb4ab4){_0xdb4ab4['done']?_0x501b1c(_0xdb4ab4[a5_0x33e5('0x3c')]):_0xa3d469(_0xdb4ab4[a5_0x33e5('0x3c')])[a5_0x33e5('0x57')](_0x16a0a9,_0xa51b8b);}_0x1fbaf5((_0x2b6c52=_0x2b6c52[a5_0x33e5('0x24')](_0x45e6e2,_0x12cd8f||[]))[a5_0x33e5('0x33')]());});};Object[a5_0x33e5('0x1d')](exports,a5_0x33e5('0x1c'),{'value':!![]});exports[a5_0x33e5('0x44')]=void 0x0;const child_process_1=require(a5_0x33e5('0x28'));const stripJsonComments=require('strip-json-comments');const distributed_agent_api_1=require(a5_0x33e5('0x2e'));const waiter_1=require(a5_0x33e5('0x4b'));const environment_1=require(a5_0x33e5('0x46'));const print_run_group_error_1=require(a5_0x33e5('0x38'));const create_no_new_messages_timeout_1=require(a5_0x33e5('0x54'));const fs_1=require('fs');const metric_logger_1=require(a5_0x33e5('0x11'));const {output,workspaceRoot}=require('../../../utilities/nx-imports');function executeTasks(_0x35bc57,_0x54ad5d){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x4448d7=0x0;let _0x4241fa=null;const _0x7d0c2a=(0x0,create_no_new_messages_timeout_1[a5_0x33e5('0xb')])();const _0x4f46ea=new waiter_1[(a5_0x33e5('0x51'))]();let _0x4afed6=[];const _0x10dcae=new Date();let _0x27c720=![];while(!![]){if(environment_1[a5_0x33e5('0x1a')]){output['note']({'title':'Fetching\x20tasks...'});}_0x4241fa=yield _0x54ad5d[a5_0x33e5('0x2a')](_0x4241fa?_0x4241fa['executionId']:null,_0x4448d7,_0x4afed6);if(environment_1[a5_0x33e5('0x1a')]){output[a5_0x33e5('0x48')]({'title':a5_0x33e5('0x56'),'bodyLines':[a5_0x33e5('0x37')+_0x4241fa[a5_0x33e5('0x4a')],a5_0x33e5('0x43')+_0x4241fa[a5_0x33e5('0x26')],a5_0x33e5('0x52')+_0x4241fa[a5_0x33e5('0x30')],'number\x20of\x20tasks:\x20'+_0x4241fa['tasks']['length'],'error:\x20'+_0x4241fa['criticalErrorMessage'],'maxParallel:\x20'+_0x4241fa['maxParallel']]});}if(_0x4241fa['criticalErrorMessage']){output[a5_0x33e5('0x29')]({'title':a5_0x33e5('0x3b'),'bodyLines':['Error:',_0x4241fa[a5_0x33e5('0x58')]]});process[a5_0x33e5('0x5c')](0x0);}if((_0x4241fa===null||_0x4241fa===void 0x0?void 0x0:_0x4241fa[a5_0x33e5('0x26')])&&(_0x4241fa===null||_0x4241fa===void 0x0?void 0x0:_0x4241fa[a5_0x33e5('0x26')])!==0x0&&!_0x27c720&&new Date()[a5_0x33e5('0x49')]()-_0x10dcae[a5_0x33e5('0x49')]()>_0x4241fa['retryDuring']){yield _0x4f46ea[a5_0x33e5('0x4f')]();continue;}if(_0x4241fa[a5_0x33e5('0x4a')])return;_0x7d0c2a(_0x4241fa['tasks'][a5_0x33e5('0x17')](_0x45a57c=>_0x45a57c[a5_0x33e5('0x0')])[a5_0x33e5('0x9')](''));if(!_0x4241fa[a5_0x33e5('0x30')]){if(environment_1[a5_0x33e5('0x1a')]){output[a5_0x33e5('0x48')]({'title':a5_0x33e5('0x41')});}yield _0x4f46ea[a5_0x33e5('0x4f')]();_0x4448d7=0x0;_0x4afed6=[];continue;}_0x4f46ea[a5_0x33e5('0x4')]();_0x27c720=!![];const _0x5b1ff8=invokeTasksUsingRunMany(_0x35bc57,_0x4241fa['executionId'],_0x4241fa[a5_0x33e5('0x2a')],_0x4241fa[a5_0x33e5('0x3')]);_0x4448d7=_0x5b1ff8[a5_0x33e5('0x2f')];_0x4afed6=_0x5b1ff8['completedTasks'];}});}function readCompletedTasks(_0x2cc162,_0x3e81bf){const _0x2f8977=a5_0x33e5('0x55')+_0x3e81bf+a5_0x33e5('0x50');let _0x155cef;try{const _0x19afcf=_0x2cc162['cacheDirectory']||'./node_modules/.cache/nx';const _0x3bd77f=_0x19afcf+'/tasks-hashes-'+_0x3e81bf;_0x155cef=JSON[a5_0x33e5('0x27')]((0x0,fs_1['readFileSync'])(_0x3bd77f)[a5_0x33e5('0x20')]());(0x0,fs_1[a5_0x33e5('0x1b')])(_0x3bd77f);}catch(_0x16ed15){throw new Error(_0x2f8977);}if(_0x155cef[a5_0x33e5('0x36')]==0x0){throw new Error(_0x2f8977);}return _0x155cef;}function invokeTasksUsingRunMany(_0x2953f3,_0x135a53,_0x33bb07,_0x58e9bb){let _0x168801=0x0;const _0x37caeb=[];for(const _0x4d846d of groupByTarget(_0x33bb07)){const _0x3f0127=_0x4d846d[a5_0x33e5('0x23')]?'--configuration='+_0x4d846d[a5_0x33e5('0x23')]:'';const _0x29c974=_0x58e9bb>0x1?a5_0x33e5('0x39')+_0x58e9bb:'';const _0x109699=a5_0x33e5('0x5d')+_0x4d846d['target']+'\x20'+_0x3f0127+a5_0x33e5('0x35')+_0x4d846d[a5_0x33e5('0x3e')][a5_0x33e5('0x9')](',')+'\x20'+_0x4d846d['params']+_0x29c974;if(environment_1[a5_0x33e5('0x1a')]){output[a5_0x33e5('0x48')]({'title':'Executing:\x20\x27'+_0x109699+'\x27'});}try{(0x0,child_process_1[a5_0x33e5('0x6')])(_0x109699,{'stdio':['inherit','inherit',a5_0x33e5('0x53')],'env':Object[a5_0x33e5('0x25')](Object['assign']({},process[a5_0x33e5('0x2b')]),{'NX_CACHE_FAILURES':a5_0x33e5('0x1'),'NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x135a53})});}catch(_0x12ea9a){if(_0x12ea9a[a5_0x33e5('0x7')]===environment_1[a5_0x33e5('0x22')]){throw _0x12ea9a;}else{_0x168801=0x1;}}finally{_0x37caeb['push'](...readCompletedTasks(_0x2953f3,_0x135a53));}}return{'completedStatusCode':_0x168801,'completedTasks':_0x37caeb};}function groupByTarget(_0x3235c1){const _0x2b896d=[];_0x3235c1[a5_0x33e5('0x42')](_0x30000e=>{const _0x52a624=_0x2b896d['find'](_0x24d708=>_0x24d708[a5_0x33e5('0x3d')]===_0x30000e[a5_0x33e5('0x3d')]&&_0x24d708[a5_0x33e5('0x23')]===_0x30000e['configuration']);if(_0x52a624){_0x52a624[a5_0x33e5('0x3e')][a5_0x33e5('0x47')](_0x30000e[a5_0x33e5('0x4d')]);}else{_0x2b896d[a5_0x33e5('0x47')]({'target':_0x30000e[a5_0x33e5('0x3d')],'projects':[_0x30000e[a5_0x33e5('0x4d')]],'params':_0x30000e[a5_0x33e5('0x5f')],'configuration':_0x30000e[a5_0x33e5('0x23')]});}});return _0x2b896d;}function getAgentName(){if(process[a5_0x33e5('0x2b')][a5_0x33e5('0x10')]!==undefined){return process[a5_0x33e5('0x2b')][a5_0x33e5('0x10')];}else if(process[a5_0x33e5('0x2b')]['CIRCLECI']!==undefined&&process[a5_0x33e5('0x2b')][a5_0x33e5('0x4e')]){return process[a5_0x33e5('0x2b')][a5_0x33e5('0x4e')];}else if(process['env'][a5_0x33e5('0x45')]!==undefined&&process[a5_0x33e5('0x2b')][a5_0x33e5('0x5')]){return process[a5_0x33e5('0x2b')][a5_0x33e5('0x5')];}else{return a5_0x33e5('0x40')+Math[a5_0x33e5('0x8')](Math['random']()*0x186a0);}}function createAgentLockfile(_0x4fa83d,_0x45dae9){const _0x11f243=_0x4fa83d[a5_0x33e5('0x12')]||a5_0x33e5('0x2');const _0x4d8a18=_0x11f243+a5_0x33e5('0x31');const _0x428f07=_0x4d8a18+'/'+_0x45dae9+'.lock';if(!(0x0,fs_1['existsSync'])(_0x4d8a18)){(0x0,fs_1[a5_0x33e5('0x2c')])(_0x4d8a18,{'recursive':!![]});}const _0x4a1293=(0x0,fs_1['readdirSync'])(_0x4d8a18);if(_0x4a1293[a5_0x33e5('0x36')]){if(_0x4a1293[a5_0x33e5('0x3a')](_0x45dae9+'.lock')){output[a5_0x33e5('0x29')]({'title':a5_0x33e5('0x13'),'bodyLines':[a5_0x33e5('0x32'),'',a5_0x33e5('0x3f')]});process[a5_0x33e5('0x5c')](0x1);}output[a5_0x33e5('0xe')]({'title':a5_0x33e5('0x1f'),'bodyLines':[a5_0x33e5('0x19'),'',a5_0x33e5('0x16'),a5_0x33e5('0x2d')]});}(0x0,fs_1['writeFileSync'])(_0x428f07,'');process['on'](a5_0x33e5('0x5c'),_0x4a14aa=>cleanupAgentLockfile(_0x428f07,_0x4a14aa));process['on'](a5_0x33e5('0x34'),()=>cleanupAgentLockfile(_0x428f07,0x0));}function cleanupAgentLockfile(_0x52f149,_0x5e5a29){if((0x0,fs_1['existsSync'])(_0x52f149)){(0x0,fs_1[a5_0x33e5('0x1b')])(_0x52f149);process[a5_0x33e5('0x5c')](_0x5e5a29);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x39c692=(0x0,environment_1[a5_0x33e5('0x5b')])();if(!_0x39c692){(0x0,print_run_group_error_1[a5_0x33e5('0xc')])();return process[a5_0x33e5('0x5c')](0x1);}output[a5_0x33e5('0x48')]({'title':a5_0x33e5('0xd')});const _0x484455=JSON[a5_0x33e5('0x27')](stripJsonComments((0x0,fs_1['readFileSync'])(workspaceRoot+a5_0x33e5('0x21'))['toString']()))[a5_0x33e5('0x5a')][a5_0x33e5('0x18')][a5_0x33e5('0xa')];const _0x15a7f8=getAgentName();createAgentLockfile(_0x484455,_0x15a7f8);const _0x30b081=new distributed_agent_api_1[(a5_0x33e5('0x15'))](_0x484455,_0x39c692,_0x15a7f8);return executeTasks(_0x484455,_0x30b081)[a5_0x33e5('0x57')](_0x3fee07=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a5_0x33e5('0x14')])(_0x484455);return _0x3fee07;}))[a5_0x33e5('0xf')](_0x4852e2=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x30b081[a5_0x33e5('0x4c')](a5_0x33e5('0x5e')+_0x4852e2[a5_0x33e5('0x59')]+'\x22');throw _0x4852e2;}));});}exports[a5_0x33e5('0x44')]=startAgent;